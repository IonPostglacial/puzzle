<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8" />
      <title>Playing with hexagons</title>
      <link href="css/font-awesome.min.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
      <script>
      const puzzle = (() => { "use strict";
        return {
          getCorrectPositions (width, height, hnum, vnum) {
            const hunit = width / hnum | 0;
            const vunit = height / vnum | 0;
            return new Array(hnum * vnum).fill(0).map((_, i) => [hunit * (i % hnum), vunit * (i / hnum | 0)]); // oh yeah !
          },
          randomPositions (width, height, hnum, vnum) {
            const hmax = width - width / hnum | 0;
            const vmax = height - height / vnum | 0;
            return new Array(hnum * vnum).fill(0).map(_ => [hmax * Math.random(), vmax * Math.random()]);
          },
          draw (ctx, img, positions, piecesPositions, hsize, vsize) {
            ctx.clearRect(0, 0, img.width * 2, img.height * 2);
            ctx.drawImage(img, 0, 0);
            ctx.beginPath();
            ctx.strokeStyle = "#ddd";
            for (let [h, v] of positions) {
              ctx.rect(h, v, img.width / hsize, img.height / vsize);
            }
            ctx.stroke();
            for (let [i, [h, v]] of piecesPositions.entries()) {
              const [correctH, correctV] = positions[i];
              ctx.drawImage(img, correctH, correctV, img.width / hsize, img.height / vsize,
                h, v, img.width / hsize, img.height / vsize);
            }
          },
          inRect ([posX, posY], [rectX, rectY, rectW, rectH]) {
            return posX >= rectX && posX <= rectX + rectW && posY >= rectY && posY <= rectY + rectH;
          }
        }
      })();

      window.onload = e => { "use strict";
        const $ = document.querySelector.bind(document);
        const puzzleCtx = $('#puzzle-img').getContext('2d');
        const uploaded = Object.assign(document.createElement('input'), { type: 'file', style: 'display:none', accept: 'image/gif, image/jpeg, image/png'});
        const puzzleImg = new Image();
        const sizes = [[3, 3], [3, 5], [5, 3]];

        let selectedSize = sizes[$('#size-selector').selectedIndex];
        let piecesPositions = [];
        let correctPositions = [];
        let selectedPiece = null;
        $('#puzzle-game').appendChild(uploaded);
        $('#load-image').onclick = e => {
          uploaded.click();
        };
        uploaded.onchange = e => {
          const READER = new FileReader();
          READER.onload = e => {
            const imageBuffer = READER.result;
            puzzleImg.src = URL.createObjectURL(new Blob([imageBuffer], {type: uploaded.files[0].type}));
          };
          READER.readAsArrayBuffer(uploaded.files[0]);
        };
        puzzleImg.onload = e => {
          URL.revokeObjectURL(puzzleImg.src);
          const [hsize, vsize] = selectedSize;
          puzzleCtx.canvas.width = puzzleImg.width * 2;
          puzzleCtx.canvas.height = puzzleImg.height;
          correctPositions = puzzle.getCorrectPositions(puzzleImg.width, puzzleImg.height, hsize, vsize);
          puzzle.draw(puzzleCtx, puzzleImg, correctPositions, piecesPositions, hsize, vsize);
        };
        $('#shuffle').onclick = e => {
          const [hsize, vsize] = selectedSize;
          piecesPositions = puzzle.randomPositions(puzzleImg.width, puzzleImg.height, hsize, vsize).map(([h, v]) => [h + puzzleImg.width, v]);
          puzzle.draw(puzzleCtx, puzzleImg, correctPositions, piecesPositions, hsize, vsize);
        };
        $('#size-selector').onchange = e => {
          selectedSize = sizes[$('#size-selector').selectedIndex];
          const [hsize, vsize] = selectedSize;
          correctPositions = puzzle.getCorrectPositions(puzzleImg.width, puzzleImg.height, hsize, vsize);
          puzzle.draw(puzzleCtx, puzzleImg, correctPositions, piecesPositions, hsize, vsize);
        }
        $('#puzzle-img').onmousedown = e => {
          const [hsize, vsize] = selectedSize;
          const oldPiece = selectedPiece;
          for (let i = 0; i < piecesPositions.length; i++) {
            const rect = [...piecesPositions[i], puzzleImg.width / hsize, puzzleImg.height / vsize];
            if (puzzle.inRect([e.offsetX, e.offsetY], rect)) {
              selectedPiece = i;
            }
          }
          if (oldPiece === selectedPiece) {
            selectedPiece = null;
          }
        }
        $('#puzzle-img').onmousemove = e => {
          const [hsize, vsize] = selectedSize;
          if (selectedPiece === null) { return; }
          piecesPositions[selectedPiece] = [e.offsetX - 0.5 * puzzleImg.width / hsize, e.offsetY - 0.5 * puzzleImg.height / vsize];
          puzzle.draw(puzzleCtx, puzzleImg, correctPositions, piecesPositions, hsize, vsize);
        }
      }
      </script>
  <body id="puzzle-game">
    <h1>Puzzle</h1>
    <ul class="tool-box">
      <li class="tool"><a id="load-image" class="btn">
        <i class="fa fa-pull-left fa-fw fa-file-image-o"></i>Charger un image
      </a></li>
      <li class="tool"><a id="shuffle" class="btn">
        <i class="fa fa-pull-left fa-fw fa-cubes"></i>Mélanger
      </a></li>
      <li class="tool"><a id="restart" class="btn">
        <i class="fa fa-pull-left fa-fw fa-undo"></i>Recommencer
      </a></li>
      <li class="tool">
        <label>
          Taille :
          <select id="size-selector" class="dropdown btn">
            <option value="0">3 × 3</option>
            <option value="1">3 × 5</option>
            <option value="2">5 × 3</option>
          </select>
        </label>
      </li>
    </ul>
    <canvas id="puzzle-img" class="centered checkboard" width="600" height="480"></canvas>
  </body>
</html>
